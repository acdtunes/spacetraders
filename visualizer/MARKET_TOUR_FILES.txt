MARKET TOUR SYSTEM - CRITICAL FILE PATHS
=========================================

ORIGINAL BOT (Full Implementation)
==================================

Core Market Tour Files:
/Users/andres.camacho/Development/Personal/spacetradersV2/bot/src/spacetraders_bot/core/market_scout.py
  - ScoutCoordinator (main tour orchestration)
  - SubtourAssignment dataclass
  - Tour balancing algorithm

/Users/andres.camacho/Development/Personal/spacetradersV2/bot/src/spacetraders_bot/core/market_partitioning.py
  - MarketPartitioner (partition strategy selection)
  - PartitionResult dataclass
  - 4 partitioning strategies (greedy, kmeans, geographic, ortools)

/Users/andres.camacho/Development/Personal/spacetradersV2/bot/src/spacetraders_bot/core/scout_services/tour_time_estimator.py
  - TourTimeEstimator service
  - EstimateTourTimeStrategy (fast nearest-neighbor)
  - CalculateTourTimeStrategy (precise OR-Tools TSP)
  - TourTimeStrategy ABC

Database & Market Data:
/Users/andres.camacho/Development/Personal/spacetradersV2/bot/src/spacetraders_bot/core/database.py
  - Database class with WAL mode
  - market_data table schema (waypoint_symbol, good_symbol, supply, activity, purchase_price, sell_price, trade_volume, last_updated, updated_by_player)
  - tour_cache table schema (system, markets, algorithm, start_waypoint, tour_order, total_distance, calculated_at)
  - Methods: update_market_data(), get_market_data(), get_cached_tour(), save_tour_cache()

/Users/andres.camacho/Development/Personal/spacetradersV2/bot/src/spacetraders_bot/core/market_repository.py
  - Market data freshness queries
  - get_stale_markets(max_age_hours) - stale data detection
  - get_recent_updates(system, limit) - freshness tracking
  - get_waypoint_good(waypoint, good) - individual good freshness
  - find_markets_selling/buying with updated_within_hours parameter
  - calculate_batch_purchase_cost() - price escalation model
  - calculate_batch_sale_revenue() - price degradation model
  - SUPPLY_MULTIPLIERS and ACTIVITY_MULTIPLIERS constants

Market Data Service:
/Users/andres.camacho/Development/Personal/spacetradersV2/bot/src/spacetraders_bot/operations/scouting/market_data_service.py
  - MarketDataService class
  - collect_market_data() - fetch from API
  - update_database() - persist with freshness timestamp
  - collect_and_update() - combined operation

Tour Execution:
/Users/andres.camacho/Development/Personal/spacetradersV2/bot/src/spacetraders_bot/operations/scouting/tour_mode.py
  - TourScoutMode class
  - plan_tour() - using OR-Tools optimizer
  - TourScoutResult dataclass

Domain Models:
/Users/andres.camacho/Development/Personal/spacetradersV2/bot/src/spacetraders_bot/domain/trading/value_objects.py
  - TradeAction (frozen dataclass)
  - RouteSegment (frozen dataclass)
  - RouteEvaluation (frozen dataclass)
  - TradeActionType enum


BOT-V2 (Destination - DDD Architecture)
=======================================

Daemon System (Already Implemented):
/Users/andres.camacho/Development/Personal/spacetradersV2/bot-v2/src/spacetraders/adapters/primary/daemon/daemon_server.py
  - DaemonServer (JSON-RPC 2.0 on Unix socket)
  - Container management and health monitoring

/Users/andres.camacho/Development/Personal/spacetradersV2/bot-v2/src/spacetraders/adapters/primary/daemon/command_container.py
  - CommandContainer (executes CQRS commands N times)
  - Dynamic command instantiation

/Users/andres.camacho/Development/Personal/spacetradersV2/bot-v2/src/spacetraders/adapters/primary/daemon/types.py
  - ContainerStatus enum
  - RestartPolicy enum
  - ContainerInfo dataclass

/Users/andres.camacho/Development/Personal/spacetradersV2/bot-v2/src/spacetraders/adapters/primary/daemon/assignment_manager.py
  - ShipAssignmentManager (ship-to-container tracking)

Database Persistence:
/Users/andres.camacho/Development/Personal/spacetradersV2/bot-v2/src/spacetraders/adapters/secondary/persistence/database.py
  - Database class (SQLite with WAL mode)
  - Tables: players, ships, routes, system_graphs, ship_assignments, containers, container_logs
  - NEEDS: market_data, tour_cache, tour_assignments tables

/Users/andres.camacho/Development/Personal/spacetradersV2/bot-v2/src/spacetraders/adapters/secondary/persistence/ship_repository.py
  - Ship aggregate queries

/Users/andres.camacho/Development/Personal/spacetradersV2/bot-v2/src/spacetraders/adapters/secondary/persistence/route_repository.py
  - Route storage (multi-waypoint navigation)

Configuration:
/Users/andres.camacho/Development/Personal/spacetradersV2/bot-v2/src/spacetraders/configuration/container.py
  - Dependency injection setup
  - Service registration
  - NEEDS: Market tour service registration


DATABASE FILE LOCATIONS
======================

Original Bot:
/Users/andres.camacho/Development/Personal/spacetradersV2/bot/var/spacetraders.db
  - Tables: market_data, tour_cache (fully populated)
  - Indexes: idx_market_waypoint, idx_market_good, idx_market_updated, idx_tour_system

Bot-V2:
/Users/andres.camacho/Development/Personal/spacetradersV2/bot-v2/var/spacetraders.db
  - Tables: players, ships, routes, system_graphs, ship_assignments, containers, container_logs
  - NEEDS: market_data, tour_cache tables


API FIELD MAPPING (CRITICAL!)
=============================

SpaceTraders API confusing naming:
- API.purchasePrice = What ship pays to BUY (high) → DB.sell_price
- API.sellPrice = What ship receives to SELL (low) → DB.purchase_price

This flip is handled in MarketDataService.update_database()


TEST FEATURES (Bot Original)
=============================

BDD Touring Tests:
/Users/andres.camacho/Development/Personal/spacetradersV2/bot/tests/bdd/steps/touring_steps.py
/Users/andres.camacho/Development/Personal/spacetradersV2/bot/tests/bdd/features/touring/
  - cache_persistence.feature
  - cache_key_format.feature
  - visualizer_consistency.feature
  - optimization_quality.feature
  - time_balancing.feature


INTEGRATION CHECKLIST FOR VISUALIZER
====================================

1. Read Market Tour Assignments:
   - Query bot-v2 database: ship_assignments table (when tour running)
   - Or query bot database: tour_cache table

2. Read Market Freshness:
   - Query market_data.last_updated (ISO timestamp)
   - Use market_repository.get_stale_markets() or get_recent_updates()

3. Display Tour Metrics:
   - SubtourAssignment.tour_time_seconds (estimated duration)
   - Market count per ship
   - Tour balancing variance

4. Track Price Impact:
   - Use calculate_batch_purchase_cost() for buy operations
   - Use calculate_batch_sale_revenue() for sell operations
   - Display supply/activity multipliers

5. Container Health:
   - Query containers table for tour_scout container status
   - Query container_logs for execution history
   - Monitor restart_count and exit_code


KEY INTERFACES FOR VISUALIZER INTEGRATION
==========================================

Read-Only Queries:

from spacetraders_bot.core.market_repository import (
    get_waypoint_goods,           # All goods at waypoint
    get_waypoint_good,            # Single good freshness
    get_stale_markets,            # Stale data detection
    get_recent_updates,           # Recent tour activity
    summarize_good,               # Aggregate statistics
)

from spacetraders_bot.core.market_scout import ScoutCoordinator
# coordinator.assignments: Dict[str, SubtourAssignment]
# coordinator.markets: List[str]
# coordinator.ships: Set[str]

from spacetraders_bot.core.database import Database
with db.connection() as conn:
    tours = db.get_cached_tour(conn, system, markets, algorithm)

